<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <title>WebVieW2 Inside Revit</title>

</head>

<body>
<div id="app"></div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<script>
    // the keys should match enum keys in c#
    const ACTIONS = {
        SelectionChanged: "selection-changed"
    }

    // this is called by WebView2 from C#
    function dispatchWebViewEvent({action, payload}) {
        // console.log(`dispatch requested ${action}`);
        if (ACTIONS[action] !== undefined) {
            // console.log(`dispatching event ${ACTIONS[action]}`);
            console.log(payload);
            document.dispatchEvent(new CustomEvent(ACTIONS[action], {detail: payload}));
        }
    }

    function postWebView2Message({action, payload}) {
        if (!action) {
            return
        }
        window.chrome?.webview?.postMessage({action, payload});
    }

    new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        mounted() {
            console.log("adding event listener");
            document.addEventListener(ACTIONS.SelectionChanged, this.setElementGuids);
        },
        data() {
            return {
                elementGuids: [],
                elementGuidToSelect: ""
            }
        },
        methods: {
            setElementGuids(e) {
                this.elementGuids = e.detail;
            },
            createSheet(){
                postWebView2Message({
                    action: "create-sheet",
                });
            }      ,
            selectGuid(){
                postWebView2Message({
                    action: "select",
                    payload: [this.elementGuidToSelect]
                });
            }
        },
        beforeDestroy() {
            document.removeEventListener(ACTIONS.SelectionChanged, this.setElementGuids);
        },
        template: `
          <v-app>
          <v-main>
            <v-container>
              <h3>WebView2 + Revit</h3>
              <h5>Revit API Readonly Method</h5>
              <v-text-field
                  v-model="elementGuidToSelect"
                  clearable
                  outlined
                  dense
                  hide-details
                  type="text"
              />
              <v-btn outlined @click="selectGuid">Select Object</v-btn>
              <h5>Revit API Transaction</h5>
              <v-btn outlined @click="createSheet">Create Sheet</v-btn>
              <p class="body-2">Selected elements</p>
              <ol>
                <li v-for="id in elementGuids" :key="id" v-text="id"/>
              </ol>
            </v-container>
          </v-main>
          </v-app>
        `
    });
</script>
</body>

</html>